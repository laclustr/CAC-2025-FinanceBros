---
import { Card, CardHeader, CardContent } from "@/components/starwind/card";
import PurchaseTab from './PurchaseTab.astro';
import DepositTab from './DepositTab.astro';
import GoalTab from './GoalTab.astro';
---

<Card class="flex-1 flex flex-col shadow-lg border-0 bg-white/80 backdrop-blur-sm">
  <CardHeader class="pb-0">
    <div class="flex border-b border-gray-200 -mx-6 px-6">
      <button
        class="tab-button flex-1 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-center border-b-2 border-blue-600 text-blue-600 hover:text-blue-700 transition-all duration-200"
        data-tab="purchase"
      >
        <div class="flex items-center justify-center gap-1 sm:gap-2">
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
          </svg>
          <span class="hidden sm:inline">Purchase</span>
          <span class="sm:hidden">Buy</span>
        </div>
      </button>
      <button
        class="tab-button flex-1 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-300 transition-all duration-200"
        data-tab="deposit"
      >
        <div class="flex items-center justify-center gap-1 sm:gap-2">
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          <span class="hidden sm:inline">Deposit</span>
          <span class="sm:hidden">Add</span>
        </div>
      </button>
      <button
        class="tab-button flex-1 px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm font-medium text-center border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-300 transition-all duration-200"
        data-tab="goal"
      >
        <div class="flex items-center justify-center gap-1 sm:gap-2">
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
          </svg>
          <span>Goal</span>
        </div>
      </button>
    </div>
  </CardHeader>

  <CardContent class="flex-1 p-4 sm:p-6 lg:p-8">
    <PurchaseTab />
    <DepositTab />
    <GoalTab />
  </CardContent>
</Card>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    const validationMessages = {
      'purchase-title': 'Please enter a purchase title',
      'purchase-amount': 'Please enter a valid amount',
      'deposit-title': 'Please enter an income source',
      'deposit-amount': 'Please enter a valid amount',
      'goal-title': 'Please enter a goal title',
      'goal-target': 'Please enter a target amount',
      'goal-deadline': 'Please select a target date',
      'investment-asset': 'Please enter an asset name',
      'investment-amount': 'Please enter an investment amount'
    };

    function switchTab(targetTab) {
      tabButtons.forEach(button => {
        button.classList.remove('border-blue-600', 'text-blue-600');
        button.classList.add('border-transparent', 'text-gray-500');
      });

      tabContents.forEach(content => {
        content.classList.add('hidden');
      });

      const activeButton = document.querySelector(`[data-tab="${targetTab}"]`);
      activeButton.classList.add('border-blue-600', 'text-blue-600');
      activeButton.classList.remove('border-transparent', 'text-gray-500');

      const activeContent = document.getElementById(`${targetTab}-tab`);
      activeContent.classList.remove('hidden');
    }

    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        switchTab(targetTab);
      });
    });

    switchTab('purchase');

    // General input formatting and validation (but no form submission handling)
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      const inputs = form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]');
      const amountInputs = form.querySelectorAll('input[name="amount"]');

      // Amount input formatting
      amountInputs.forEach(input => {
        input.addEventListener('input', function() {
          const raw = this.value;
          const cursorStart = this.selectionStart;
          let value = raw.replace(/,/g, '');
          const validChars = value.match(/^(\d*)(\.?)(\d*)/) || [];
          let intPart = validChars[1] || '';
          let dot = validChars[2] || '';
          let decPart = validChars[3] || '';

          if (decPart.length > 2) {
            const rounded = Math.round(parseFloat(intPart + '.' + decPart) * 100) / 100;
            const [newInt, newDec = ''] = rounded.toFixed(2).split('.');
            intPart = newInt;
            decPart = newDec;
            dot = '.';
          }

          const intWithCommas = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          let formattedValue = intWithCommas;
          if (dot) {
            formattedValue += '.' + decPart;
          }

          const oldLeft = raw.slice(0, cursorStart);
          const newLeft = formattedValue.slice(0, cursorStart);
          const commasBefore = (oldLeft.match(/,/g) || []).length;
          const commasAfter = (newLeft.match(/,/g) || []).length;
          const diff = commasAfter - commasBefore;

          this.value = formattedValue;
          this.setSelectionRange(cursorStart + diff, cursorStart + diff);
        });
      });

      // Field validation on blur and input
      inputs.forEach(input => {
        input.addEventListener('blur', function() {
          validateField(this);
        });

        input.addEventListener('input', function() {
          const errorDiv = this.parentNode.querySelector('.error-message');
          if (errorDiv && !this.classList.contains('border-red-500')) {
            errorDiv.classList.add('hidden');
            this.classList.remove('border-red-500');
          }
        });
      });

      // REMOVED: The conflicting form submission handler that was causing issues
      // Each tab now handles its own form submission logic independently
    });

    function validateField(field) {
      const value = field.value.trim();
      const errorDiv = field.parentNode.querySelector('.error-message');
      const fieldId = field.id;
      let isValid = true;
      let errorMessage = '';

      if (!value) {
        isValid = false;
        errorMessage = validationMessages[fieldId] || 'This field is required';
      } else if (
        field.name === 'amount' &&
        (value === '' || isNaN(value.replace(/,/g, '')) || parseFloat(value.replace(/,/g, '')) <= 0)
      ) {
        isValid = false;
        errorMessage = 'Please enter a valid positive number';
      } else if (field.type === 'date' && new Date(value) < new Date()) {
        if (fieldId === 'goal-deadline') {
          isValid = false;
          errorMessage = 'Please select a future date';
        }
      }

      if (!isValid) {
        field.classList.add('border-red-500');
        if (errorDiv) {
          errorDiv.textContent = errorMessage;
          errorDiv.classList.remove('hidden');
        }
      } else {
        field.classList.remove('border-red-500');
        if (errorDiv) {
          errorDiv.classList.add('hidden');
        }
      }

      return isValid;
    }

    // Keep the investment form handler since it's specific and doesn't conflict
    const investmentForm = document.getElementById('investment-form');

    if (investmentForm) {
      investmentForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const inputs = investmentForm.querySelectorAll('input[type="text"], input[type="number"]');
        const submitButton = investmentForm.querySelector('button[type="submit"]');
        const submitText = submitButton.querySelector('.submit-text');
        const loadingText = submitButton.querySelector('.loading-text');

        let isValid = true;
        inputs.forEach(input => {
          if (!validateField(input)) {
            isValid = false;
          }
        });

        if (!isValid) return;

        const amountField = investmentForm.querySelector('input[name="amount"]');
        if (amountField && amountField.value) {
          amountField.value = amountField.value.replace(/,/g, '');
        }

        submitText.classList.add('hidden');
        loadingText.classList.remove('hidden');
        submitButton.disabled = true;

        const formData = new FormData(investmentForm);

        try {
          const response = await fetch(investmentForm.action, {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (response.ok && result.success) {
            window.location.href = '/dashboard';
          } else {
            throw new Error(result.error || 'Something went wrong');
          }
        } catch (err) {
          console.error('Submission error:', err);
          submitText.classList.remove('hidden');
          loadingText.classList.add('hidden');
          submitButton.disabled = false;

          const assetInput = investmentForm.querySelector('#investment-asset');
          const errorDiv = assetInput?.parentNode?.querySelector('.error-message');
          if (errorDiv) {
            errorDiv.textContent = err.message;
            errorDiv.classList.remove('hidden');
            assetInput.classList.add('border-red-500');
          }
        }
      });
    }
  });
</script>